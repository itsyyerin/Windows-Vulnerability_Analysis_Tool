using System;
using System.Collections.Generic;
using Microsoft.Win32;

namespace Windows_Vulnerability_Analysis_Tool
{
    public class PC_14
    {
        public int CheckActiveXStatus()
        {
            List<string> installedActiveXList = GetDownloadedControlsList();

            if (installedActiveXList.Count == 0)
            {
                return 1;
            }

            DateTime threeMonthsAgo = DateTime.Now.AddMonths(-3);

            bool isSecure = true;

            foreach (string activeX in installedActiveXList)
            {
                DateTime lastUsedDate = GetLastUsedDate(activeX);

                if (lastUsedDate == DateTime.MinValue || lastUsedDate < threeMonthsAgo)
                {
                    UninstallActiveX(activeX);
                    isSecure = false;
                }
            }

            if (isSecure || installedActiveXList.Count == 0) // 설치된 Active X가 없는 경우에도 양호로 처리
            {
                return 1;
            }
            else
            {
                return 0;
            }
        }

        private static List<string> GetDownloadedControlsList()
        {
            List<string> installedActiveXList = new List<string>();

            // HKEY_CLASSES_ROOT\CLSID 아래에 설치된 ActiveX의 정보가 저장되어 있을 수 있습니다.
            using (RegistryKey classKey = Registry.ClassesRoot.OpenSubKey("CLSID"))
            {
                if (classKey != null)
                {
                    foreach (string clsid in classKey.GetSubKeyNames())
                    {
                        using (RegistryKey subKey = classKey.OpenSubKey($"{clsid}\\InprocServer32"))
                        {
                            if (subKey != null)
                            {
                                string filePath = subKey.GetValue(null) as string;
                                if (!string.IsNullOrEmpty(filePath))
                                {
                                    installedActiveXList.Add(filePath);
                                }
                            }
                        }
                    }
                }
            }

            return installedActiveXList;
        }

        private static DateTime GetLastUsedDate(string activeX)
        {
            DateTime lastUsedDate = DateTime.MinValue;

            // ActiveX의 마지막 사용 날짜를 Registry에서 확인하는 예시입니다.
            // HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Ext\Stats 경로에 ActiveX의 사용 기록이 저장되어 있을 수 있습니다.
            using (RegistryKey statsKey = Registry.CurrentUser.OpenSubKey(@"Software\Microsoft\Windows\CurrentVersion\Ext\Stats"))
            {
                if (statsKey != null)
                {
                    string activeXKeyPath = null;
                    foreach (string subKeyName in statsKey.GetSubKeyNames())
                    {
                        using (RegistryKey subKey = statsKey.OpenSubKey(subKeyName))
                        {
                            string clsid = subKey.GetValue("CLSID") as string;
                            if (!string.IsNullOrEmpty(clsid) && clsid.Equals(activeX, StringComparison.OrdinalIgnoreCase))
                            {
                                activeXKeyPath = subKeyName;
                                break;
                            }
                        }
                    }

                    if (!string.IsNullOrEmpty(activeXKeyPath))
                    {
                        using (RegistryKey activeXKey = statsKey.OpenSubKey(activeXKeyPath))
                        {
                            object lastUsedValue = activeXKey.GetValue("LastUsedTime");
                            if (lastUsedValue is long lastUsedTicks)
                            {
                                lastUsedDate = DateTime.FromFileTimeUtc(lastUsedTicks);
                            }
                        }
                    }
                }
                else
                {
                    // statsKey가 null인 경우, ActiveX가 설치되어 있지 않은 것으로 간주하여 양호로 처리
                    lastUsedDate = DateTime.MaxValue;
                }
            }

            return lastUsedDate;
        }


        private static void UninstallActiveX(string activeX)
        {
            // ActiveX를 삭제하는 로직
            // 구현해야 함
        }
    }
}
