using System;
using System.Linq;
using System.Management;

namespace Windows_Vulnerability_Analysis_Tool
{
    public class PC_09
    {
        public int ChcekInstallationAutoUpdate()
        {
            try
            {
                ManagementObjectSearcher searcher = new ManagementObjectSearcher("root\\SecurityCenter2", "SELECT * FROM AntivirusProduct");

                foreach (ManagementObject obj in searcher.Get())
                {
                    UInt32 updateStatus = (UInt32)obj["productState"];

                    string binaryState = Convert.ToString((Int32)updateStatus, 2).PadLeft(32, '0');
                    string binaryStateGrouped = InsertSpaceEveryNChars(binaryState.Substring(12), 4);

                    bool antivirusExists = binaryStateGrouped[1] == '1';
                    bool isLatestVersion = binaryStateGrouped[15] == '0';

                    if (!antivirusExists || !isLatestVersion)
                    {
                        return 0;
                    }

                }
                return 1;
            }
            catch (Exception ex)
            {
                return 0;
            }

        }

        static string InsertSpaceEveryNChars(string str, int n)
        {
            return string.Join(" ", Enumerable.Range(0, str.Length / n)
                .Select(i => str.Substring(i * n, n)));
        }
    }

}
